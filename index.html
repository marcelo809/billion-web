<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BILLION — INVERNORD Reports</title>

  <style>
    :root{
      --bg:#0b0f19;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --shadow:0 24px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(124,58,237,.25), transparent 65%),
        radial-gradient(1000px 700px at 85% 0%, rgba(6,182,212,.18), transparent 60%),
        var(--bg);
      color:var(--text);
      letter-spacing:.2px;
    }
    .wrap{ max-width:1180px; margin:0 auto; padding:28px 20px 80px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom:18px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{ width:40px; height:40px; border-radius:12px;
      background: linear-gradient(135deg, rgba(124,58,237,.9), rgba(6,182,212,.75));
      box-shadow:0 16px 40px rgba(124,58,237,.22);
    }
    .brand h1{ font-size:18px; margin:0; font-weight:750; letter-spacing:.6px; }
    .brand .sub{ font-size:12px; color:var(--muted2); margin-top:2px; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:10px 12px;
      border-radius:14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      transition:.15s ease;
      user-select:none;
      font-weight:600;
      font-size:13px;
    }
    .btn:hover{ transform:translateY(-1px); background:rgba(255,255,255,.06); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.75));
      border-color: rgba(255,255,255,.14);
      box-shadow: 0 18px 48px rgba(124,58,237,.18);
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      margin-bottom:16px;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(900px 220px at 20% 0%, rgba(124,58,237,.14), transparent 60%),
        radial-gradient(900px 220px at 80% 0%, rgba(6,182,212,.10), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }
    .panel > *{ position:relative; }

    .section-title{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .section-title h2{ font-size:14px; margin:0; font-weight:750; letter-spacing:.4px; }
    .section-title .hint{ font-size:12px; color:var(--muted2); line-height:1.2; }

    .grid{ display:grid; grid-template-columns: .9fr 1.1fr; gap:16px; }
    @media (max-width:980px){ .grid{ grid-template-columns: 1fr; } }

    .form{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px; }
    @media (max-width:640px){ .form{ grid-template-columns: 1fr; } }

    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:12px; color:var(--muted2); }

    input, textarea, select{
      background: rgba(0,0,0,.18);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 10px 12px;
      color: var(--text);
      outline: none;
      font-size: 13px;
    }
    textarea{ min-height: 110px; resize: vertical; line-height:1.35; }

    .hr{ height:1px; background: rgba(255,255,255,.08); margin:14px 0; }

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: rgba(255,255,255,.03);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      overflow:hidden;
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      text-align: left;
      vertical-align: middle;
    }
    th{
      color: rgba(255,255,255,.7);
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .3px;
      background: rgba(255,255,255,.03);
    }
    tr:last-child td{ border-bottom:none; }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .item{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      border-radius:16px;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .item .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .item .meta .t{
      font-weight:750;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item .meta .s{
      font-size:12px;
      color:var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item .controls{ display:flex; gap:8px; flex-wrap:wrap; }
    .mini{ font-size:12px; color:var(--muted2); margin-top:10px; line-height:1.35; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.9);
      font-size: 13px;
      box-shadow: 0 18px 48px rgba(0,0,0,.35);
      opacity: 0;
      pointer-events: none;
      transition: .18s ease;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-2px); }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>BILLION</h1>
          <div class="sub">INVERNORD · Generador de Reporte Maestro (MVP)</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnNew">+ Nuevo Reporte</button>
        <button class="btn" id="btnSave">Guardar</button>
        <button class="btn primary" id="btnPdf">Generar PDF (cliente)</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Report list + PDF upload reference -->
      <div class="panel">
        <div class="section-title">
          <h2>Reportes</h2>
          <div class="hint">Cada PDF = un reporte nuevo (MVP: llenado manual)</div>
        </div>

        <div class="field">
          <label>Subir PDF de referencia (no parsea aún)</label>
          <input type="file" id="pdfFile" accept="application/pdf" />
        </div>
        <div class="mini">
          MVP: guardamos nombre del archivo y lo asociamos al reporte. Parsing automático viene en fase 2 (backend/Actions).
        </div>

        <div class="hr"></div>

        <div class="field">
          <label>Buscar</label>
          <input id="search" placeholder="Buscar por ticker o nombre..." />
        </div>

        <div class="list" id="reportList"></div>

        <div class="mini">
          Tip: si algo se desacomoda, refresca y vuelve a abrir el reporte desde la lista.
        </div>
      </div>

      <!-- RIGHT: Report editor -->
      <div class="panel">
        <div class="section-title">
          <h2>Editor · Reporte Maestro</h2>
          <div class="hint"><span id="activeId">—</span></div>
        </div>

        <div class="form">
          <div class="field">
            <label>Cliente</label>
            <input id="clientName" placeholder="Cliente / Cuenta" />
          </div>
          <div class="field">
            <label>Firma</label>
            <input id="firmName" placeholder="INVERNORD" />
          </div>
          <div class="field">
            <label>Fecha</label>
            <input id="reportDate" placeholder="Febrero 2026" />
          </div>
          <div class="field">
            <label>Ticker</label>
            <input id="ticker" placeholder="PLTR" />
          </div>
          <div class="field">
            <label>Nombre de la empresa</label>
            <input id="company" placeholder="Palantir Technologies Inc." />
          </div>
          <div class="field">
            <label>Archivo PDF (referencia)</label>
            <input id="pdfName" placeholder="TICKER - 02 2026.pdf" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="field">
          <label>Perspectiva General</label>
          <textarea id="overview" placeholder="Qué hace la empresa, sector, ventaja, etc."></textarea>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>Datos Clave del Ticker (uno por línea: Métrica: Valor)</label>
          <textarea id="keyData" placeholder="Último cierre: USD ...&#10;Market Cap: ...&#10;P/E: ..."></textarea>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>Análisis y Comentarios</label>
          <textarea id="analysis" placeholder="Contexto reciente, drivers, riesgos, valoración..."></textarea>
        </div>

        <div class="form" style="margin-top:10px;">
          <div class="field">
            <label>Puntos Positivos (uno por línea)</label>
            <textarea id="pros" placeholder="• ..."></textarea>
          </div>
          <div class="field">
            <label>Puntos Negativos (uno por línea)</label>
            <textarea id="cons" placeholder="• ..."></textarea>
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>Conclusión y Recomendación</label>
          <textarea id="conclusion" placeholder="Postura sugerida, perfil, horizonte..."></textarea>
        </div>

        <div class="hr"></div>

        <div class="field">
          <label>Disclaimer regulatorio (sale en el PDF)</label>
          <textarea id="disclaimer"></textarea>
        </div>

        <div class="mini">
          Cuando le des “Generar PDF”, se crea un PDF listo para cliente con formato limpio (INVERNORD).
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Listo</div>

  <script>
    const $ = (id) => document.getElementById(id);

    const STORAGE_KEY = "billion_reports_v1";
    let reports = [];
    let activeReportId = null;

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=> t.classList.remove("show"), 1600);
    }

    function uid(){
      return "R" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        reports = raw ? JSON.parse(raw) : [];
      }catch(e){ reports = []; }
    }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(reports));
    }

    function defaultDisclaimer(){
      return "Este reporte es únicamente informativo y no constituye una recomendación personalizada, oferta, invitación o solicitud para comprar o vender valores. El desempeño pasado no garantiza resultados futuros. Las opiniones y estimaciones reflejan el criterio de INVERNORD a la fecha del reporte y pueden cambiar sin previo aviso. Antes de invertir, evalúe sus objetivos, horizonte y tolerancia al riesgo y, de ser necesario, consulte a un asesor financiero y fiscal.";
    }

    function newReport(){
      const r = {
        id: uid(),
        createdAt: new Date().toISOString(),
        clientName: "",
        firmName: "INVERNORD",
        reportDate: new Date().toLocaleDateString("es-MX"),
        ticker: "",
        company: "",
        pdfName: "",
        overview: "",
        keyData: "",
        analysis: "",
        pros: "",
        cons: "",
        conclusion: "",
        disclaimer: defaultDisclaimer(),
      };
      reports.unshift(r);
      activeReportId = r.id;
      save();
      renderList();
      fillForm(r);
      toast("Nuevo reporte creado");
    }

    function getActive(){
      return reports.find(r => r.id === activeReportId) || null;
    }

    function fillForm(r){
      $("activeId").textContent = r ? `ID: ${r.id}` : "—";
      $("clientName").value = r?.clientName || "";
      $("firmName").value = r?.firmName || "INVERNORD";
      $("reportDate").value = r?.reportDate || "";
      $("ticker").value = r?.ticker || "";
      $("company").value = r?.company || "";
      $("pdfName").value = r?.pdfName || "";
      $("overview").value = r?.overview || "";
      $("keyData").value = r?.keyData || "";
      $("analysis").value = r?.analysis || "";
      $("pros").value = r?.pros || "";
      $("cons").value = r?.cons || "";
      $("conclusion").value = r?.conclusion || "";
      $("disclaimer").value = r?.disclaimer || defaultDisclaimer();
    }

    function pullForm(){
      const r = getActive();
      if(!r) return null;
      r.clientName = $("clientName").value.trim();
      r.firmName = $("firmName").value.trim() || "INVERNORD";
      r.reportDate = $("reportDate").value.trim();
      r.ticker = $("ticker").value.trim().toUpperCase();
      r.company = $("company").value.trim();
      r.pdfName = $("pdfName").value.trim();
      r.overview = $("overview").value.trim();
      r.keyData = $("keyData").value.trim();
      r.analysis = $("analysis").value.trim();
      r.pros = $("pros").value.trim();
      r.cons = $("cons").value.trim();
      r.conclusion = $("conclusion").value.trim();
      r.disclaimer = $("disclaimer").value.trim() || defaultDisclaimer();
      return r;
    }

    function renderList(){
      const q = $("search").value.trim().toLowerCase();
      const list = $("reportList");
      list.innerHTML = "";

      const filtered = reports.filter(r=>{
        const hay = `${r.ticker} ${r.company} ${r.clientName} ${r.pdfName}`.toLowerCase();
        return q ? hay.includes(q) : true;
      });

      if(!filtered.length){
        const div = document.createElement("div");
        div.className = "mini";
        div.textContent = "No hay reportes todavía. Crea uno con “+ Nuevo Reporte”.";
        list.appendChild(div);
        return;
      }

      filtered.forEach(r=>{
        const item = document.createElement("div");
        item.className = "item";
        const t = (r.ticker ? `${r.ticker}` : "Sin ticker") + (r.company ? ` — ${r.company}` : "");
        const s = `${r.clientName || "Cliente"} · ${r.reportDate || "Sin fecha"} · ${r.pdfName || "Sin PDF"}`;

        item.innerHTML = `
          <div class="meta">
            <div class="t">${escapeHtml(t)}</div>
            <div class="s">${escapeHtml(s)}</div>
          </div>
          <div class="controls">
            <button class="btn" data-open="${r.id}">Abrir</button>
            <button class="btn" data-del="${r.id}">Borrar</button>
          </div>
        `;
        list.appendChild(item);
      });

      list.querySelectorAll("button[data-open]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-open");
          activeReportId = id;
          const r = getActive();
          fillForm(r);
          toast("Reporte abierto");
        });
      });

      list.querySelectorAll("button[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-del");
          reports = reports.filter(r=>r.id !== id);
          if(activeReportId === id) activeReportId = reports[0]?.id || null;
          save();
          renderList();
          fillForm(getActive());
          toast("Reporte borrado");
        });
      });
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function parseKeyDataLines(txt){
      const lines = (txt || "").split("\n").map(l=>l.trim()).filter(Boolean);
      return lines.map(l=>{
        const idx = l.indexOf(":");
        if(idx === -1) return [l, ""];
        return [l.slice(0, idx).trim(), l.slice(idx+1).trim()];
      });
    }

    async function generatePdf(){
      const r = pullForm();
      if(!r){ toast("Crea/abre un reporte primero"); return; }
      save();
      renderList();

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"pt", format:"letter" });

      const M = { left:54, right:54, top:54, bottom:54 };
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const contentW = pageW - M.left - M.right;

      function header(title, subtitle){
        doc.setFont("helvetica","bold"); doc.setFontSize(18);
        doc.text(title, M.left, M.top);
        doc.setFont("helvetica","normal"); doc.setFontSize(10);
        doc.setTextColor(80);
        doc.text(subtitle, M.left, M.top + 18);
        doc.setTextColor(0);
      }
      function sectionTitle(txt, y){
        doc.setFont("helvetica","bold"); doc.setFontSize(12);
        doc.text(txt, M.left, y);
        doc.setDrawColor(230);
        doc.line(M.left, y + 6, pageW - M.right, y + 6);
        return y + 18;
      }
      function para(txt, y){
        doc.setFont("helvetica","normal"); doc.setFontSize(10.5);
        doc.setTextColor(30);
        const lines = doc.splitTextToSize(txt || "—", contentW);
        doc.text(lines, M.left, y);
        doc.setTextColor(0);
        return y + lines.length * 14;
      }

      const ticker = r.ticker || "TICKER";
      const company = r.company || "Empresa";
      const client = r.clientName || "Cliente";
      const firm = r.firmName || "INVERNORD";
      const date = r.reportDate || new Date().toLocaleDateString("es-MX");

      // PAGE 1
      header(`${firm} — Reporte Maestro`, `${ticker} · ${company} · ${client} · ${date}`);

      let y = M.top + 54;
      y = sectionTitle("1) Perspectiva General", y);
      y = para(r.overview || "—", y) + 6;

      y = sectionTitle("2) Datos Clave del Ticker", y);
      const kd = parseKeyDataLines(r.keyData);
      doc.autoTable({
        startY: y,
        head: [["Métrica","Valor"]],
        body: kd.length ? kd : [["—","—"]],
        styles: { font:"helvetica", fontSize:10, cellPadding:7, overflow:"linebreak" },
        headStyles: { fillColor:[245,245,245], textColor:20 },
        columnStyles: { 0:{cellWidth:200}, 1:{cellWidth:320} },
        margin: { left:M.left, right:M.right }
      });
      y = doc.lastAutoTable.finalY + 14;

      y = sectionTitle("3) Análisis y Comentarios", y);
      y = para(r.analysis || "—", y) + 6;

      // PAGE 2
      doc.addPage();
      header(`${firm} — Reporte Maestro`, `${ticker} · ${company} · ${client} · ${date}`);

      y = M.top + 54;
      y = sectionTitle("4) Puntos Positivos y Negativos", y);

      const prosLines = (r.pros || "").split("\n").map(s=>s.trim()).filter(Boolean);
      const consLines = (r.cons || "").split("\n").map(s=>s.trim()).filter(Boolean);

      doc.setFont("helvetica","bold"); doc.setFontSize(10.5);
      doc.text("Positivos:", M.left, y); y += 14;
      doc.setFont("helvetica","normal");
      const pText = (prosLines.length ? prosLines : ["—"]).map(p=>p.startsWith("•")?p:"• "+p).join("\n");
      doc.text(doc.splitTextToSize(pText, contentW), M.left, y);
      y += doc.splitTextToSize(pText, contentW).length * 14 + 10;

      doc.setFont("helvetica","bold");
      doc.text("Negativos:", M.left, y); y += 14;
      doc.setFont("helvetica","normal");
      const cText = (consLines.length ? consLines : ["—"]).map(c=>c.startsWith("•")?c:"• "+c).join("\n");
      doc.text(doc.splitTextToSize(cText, contentW), M.left, y);
      y += doc.splitTextToSize(cText, contentW).length * 14 + 10;

      y = sectionTitle("5) Conclusión y Recomendación", y);
      y = para(r.conclusion || "—", y) + 6;

      y = sectionTitle("Disclaimer", y);
      y = para(r.disclaimer || defaultDisclaimer(), y);

      doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(120);
      doc.text(`Preparado por: ${firm}`, M.left, pageH - 36);
      doc.text(`Referencia PDF: ${r.pdfName || "—"}`, pageW - M.right, pageH - 36, { align:"right" });
      doc.setTextColor(0);

      const safeFile = `${ticker}_${date.replace(/[^0-9A-Za-z_-]/g,"-")}_INVERNORD.pdf`;
      doc.save(safeFile);
      toast("PDF generado ✅");
    }

    // Events
    $("btnNew").addEventListener("click", newReport);
    $("btnSave").addEventListener("click", ()=>{
      if(!getActive()){ toast("Crea un reporte primero"); return; }
      pullForm();
      save();
      renderList();
      toast("Guardado");
    });
    $("btnPdf").addEventListener("click", generatePdf);
    $("search").addEventListener("input", renderList);

    $("pdfFile").addEventListener("change", (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      if(!getActive()){
        newReport();
      }
      $("pdfName").value = file.name;
      pullForm();
      save();
      renderList();
      toast("PDF asociado (MVP)");
      // Nota: no parseamos todavía
    });

    // Boot
    load();
    if(reports.length){
      activeReportId = reports[0].id;
      fillForm(getActive());
    }else{
      fillForm(null);
      $("disclaimer").value = defaultDisclaimer();
      $("firmName").value = "INVERNORD";
    }
    renderList();
  </script>
</body>
</html>
